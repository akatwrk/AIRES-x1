#include <ESP32Servo.h>
#include <esp_now.h>
#include <WiFi.h>

// ================= CONFIGURATION =================
#define PIN_BASE     13
#define PIN_SHOULDER 12
#define PIN_ELBOW    14
#define PIN_WRIST    27
#define PIN_GRIPPER  25 

// DEADBAND (Crucial for stopping Jitter)
// The motor will ignore changes smaller than this value.
// Start at 2. If it still jitters, increase to 3 or 4.
int DEADBAND = 2; 

// SPEED LIMITS (Safety)
float SPEED_BASE     = 0.6; 
float SPEED_SHOULDER = 0.4; 
float SPEED_ELBOW    = 0.4;
float SPEED_WRIST    = 1.0; 
float SPEED_GRIPPER  = 1.5;

// ================= VARIABLES =================
Servo sBase, sShoulder, sElbow, sWrist, sGripper;

float currBase = 90, currShoulder = 90, currElbow = 90, currWrist = 90, currGripper = 90;
int targetBase=90, targetShoulder=90, targetElbow=90, targetWrist=90, targetGripper=90;

typedef struct struct_message {
  int base, shoulder, elbow, wrist, gripper;
} struct_message;

struct_message incomingData;

void OnDataRecv(const uint8_t * mac, const uint8_t *incomingDataPtr, int len) {
  struct_message temp;
  memcpy(&temp, incomingDataPtr, sizeof(temp));

  // DEADBAND CHECK: Only update target if change is significant
  if (abs(temp.base - targetBase) > DEADBAND) targetBase = temp.base;
  if (abs(temp.shoulder - targetShoulder) > DEADBAND) targetShoulder = temp.shoulder;
  if (abs(temp.elbow - targetElbow) > DEADBAND) targetElbow = temp.elbow;
  if (abs(temp.wrist - targetWrist) > DEADBAND) targetWrist = temp.wrist;
  
  targetGripper = temp.gripper; // Gripper is usually boolean/snappy, no deadband needed
}

void setup() {
  Serial.begin(115200);
  sBase.attach(PIN_BASE);
  sShoulder.attach(PIN_SHOULDER);
  sElbow.attach(PIN_ELBOW);
  sWrist.attach(PIN_WRIST);
  sGripper.attach(PIN_GRIPPER);

  // Safety Start
  sBase.write(90); sShoulder.write(90); sElbow.write(90); sWrist.write(90); sGripper.write(90);
  delay(1000);

  WiFi.mode(WIFI_STA);
  if (esp_now_init() != ESP_OK) return;
  esp_now_register_recv_cb(OnDataRecv);
}

float smoothMove(float current, int target, float speed) {
  float diff = target - current;
  if (abs(diff) < speed) return target;
  if (diff > 0) return current + speed;
  else return current - speed;
}

void loop() {
  currBase     = smoothMove(currBase, targetBase, SPEED_BASE);
  currShoulder = smoothMove(currShoulder, targetShoulder, SPEED_SHOULDER);
  currElbow    = smoothMove(currElbow, targetElbow, SPEED_ELBOW);
  currWrist    = smoothMove(currWrist, targetWrist, SPEED_WRIST);
  currGripper  = smoothMove(currGripper, targetGripper, SPEED_GRIPPER);

  sBase.write((int)currBase);
  sShoulder.write((int)currShoulder);
  sElbow.write((int)currElbow);
  sWrist.write((int)currWrist);
  sGripper.write((int)currGripper);

  delay(10); 
}
